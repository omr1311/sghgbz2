<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Eğik Atış Simülasyonu — HTML Tek Dosya</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Plotly CDN for interaktif grafikler -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    body { font-family: Inter, Roboto, Arial, sans-serif; margin: 18px; color:#111; background:#f7f9fb; }
    h1 { margin: 0 0 8px 0; font-size: 22px; }
    .row { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .panel { background:white; border-radius:8px; padding:12px; box-shadow:0 1px 6px rgba(20,30,50,0.06); }
    .controls { width:360px; min-width:280px; }
    .controls label { display:block; font-size:13px; margin-top:8px; color:#333; }
    .controls input[type="number"], .controls input[type="text"], .controls select { width:100%; padding:8px; border-radius:6px; border:1px solid #d6dbe0; box-sizing:border-box; }
    .controls input[type="range"] { width:100%; }
    .btn { display:inline-block; margin-top:10px; padding:8px 12px; border-radius:6px; background:#0b69ff; color:white; border:none; cursor:pointer; }
    .btn.secondary { background:#e6eefc; color:#0b69ff; border:1px solid #cfe0ff; }
    .summary { min-width:260px; max-width:420px; }
    .summary p { margin:6px 0; font-size:14px; }
    #plots { flex:1 1 720px; min-width:360px; }
    .plot { background:white; border-radius:8px; padding:8px; margin-bottom:12px; }
    table { border-collapse:collapse; width:100%; font-size:13px; }
    th, td { padding:6px 8px; border-bottom:1px solid #eef2f6; text-align:right; }
    th { background:#fbfdff; text-align:center; font-weight:600; }
    .small { font-size:12px; color:#666; }
    .footer { margin-top:12px; font-size:13px; color:#444; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .codebox { font-family:monospace; font-size:12px; background:#0f1720; color:#e6eefc; padding:8px; border-radius:6px; overflow:auto; max-height:220px; }
  </style>
</head>
<body>
  <h1>Eğik Atış Simülasyonu — Tek Dosya HTML</h1>
  <div class="row">
    <div class="panel controls">
      <strong>Parametreler</strong>
      <label>İlk hız v₀ (m/s)
        <input id="v0" type="number" step="0.1" value="25" />
      </label>
      <label>Açı θ (derece)
        <input id="theta" type="number" step="0.1" value="45" />
      </label>
      <label>Başlangıç yüksekliği h₀ (m)
        <input id="h0" type="number" step="0.01" value="0" />
      </label>
      <label>
        Dünya ivmesi (varsayılan) ay = -20 m/s² (aşağı negatif)
      </label>
      <label>
        Manuel ivme kullan
        <select id="useManual">
          <option value="false">Hayır (ax=0, ay=-20)</option>
          <option value="true">Evet (ax_manual, ay_manual kullanılacak)</option>
        </select>
      </label>
      <label>ax_manual (m/s²)
        <input id="ax_manual" type="number" step="0.01" value="0.0" />
      </label>
      <label>ay_manual (m/s²) (aşağı negatif)
        <input id="ay_manual" type="number" step="0.01" value="-20.0" />
      </label>
      <label>Zaman adımı dt (s)
        <input id="dt" type="number" step="0.0001" value="0.01" />
      </label>
      <label>Maksimum simülasyon süresi max_time (s)
        <input id="max_time" type="number" step="0.1" value="30.0" />
      </label>
      <label>Hedef minimum satır sayısı (en az)
        <input id="min_rows" type="number" step="1" value="1000" />
      </label>

      <div style="margin-top:10px;">
        <button id="runBtn" class="btn">Simülasyonu Çalıştır</button>
        <button id="resetBtn" class="btn secondary">Parametreleri Sıfırla</button>
      </div>

      <div style="margin-top:12px;">
        <button id="downloadCsv" class="btn secondary">CSV İndir</button>
        <button id="copyCsv" class="btn secondary">CSV Kopyala Panoya</button>
      </div>

      <div style="margin-top:12px;">
        <div class="small">Not: Kod RK4 entegrasyonu ile hesap yapar; dt küçültüldüğünde doğruluk artar.</div>
      </div>
    </div>

    <div class="panel summary">
      <strong>Özet</strong>
      <div id="summaryBox">
        <p>Henüz simülasyon çalıştırılmadı.</p>
      </div>
      <div style="margin-top:8px;">
        <strong>İlk 10 satır</strong>
        <div id="first10" style="margin-top:6px;"></div>
      </div>
      <div style="margin-top:8px;">
        <strong>Son 10 satır</strong>
        <div id="last10" style="margin-top:6px;"></div>
      </div>
    </div>

    <div id="plots" class="panel">
      <div class="flex-between">
        <strong>Grafikler (eksende sayılar, işaretler ve hover değerleri gösterilir)</strong>
        <div class="small">Zoom & pan ile detay inceleyebilirsiniz</div>
      </div>

      <div id="posPlot" class="plot" style="height:320px;"></div>
      <div id="speedPlot" class="plot" style="height:300px;"></div>
      <div id="accPlot" class="plot" style="height:240px;"></div>
    </div>
  </div>

  <div class="footer">
    <div class="small">Bu HTML tek dosya içinde veri üretir, görselleştirir ve CSV olarak dışa aktarır. Grafikler Plotly ile çizilir; eksenlerde sayılar ve hover bilgileri görünür.</div>
  </div>

  <script>
  // ---------- Yardımcı fonksiyonlar ----------
  function deg2rad(d) { return d * Math.PI / 180.0; }
  function formatNum(x, n=5) { return Number.parseFloat(x).toFixed(n); }

  // RK4 integrator for 2D motion with constant acceleration (ax, ay)
  // state: [x, y, vx, vy]
  function derivatives(state, acc) {
    return [ state[2], state[3], acc[0], acc[1] ];
  }
  function rk4_step(state, acc, dt) {
    const k1 = derivatives(state, acc);
    const s2 = state.map((v,i) => v + 0.5*dt*k1[i]);
    const k2 = derivatives(s2, acc);
    const s3 = state.map((v,i) => v + 0.5*dt*k2[i]);
    const k3 = derivatives(s3, acc);
    const s4 = state.map((v,i) => v + dt*k3[i]);
    const k4 = derivatives(s4, acc);
    return state.map((v,i) => v + dt*(k1[i] + 2*k2[i] + 2*k3[i] + k4[i]) / 6.0);
  }

  // CSV oluşturucu
  function arrayToCSV(rows) {
    const header = ['t (s)','x (m)','y (m)','vx (m/s)','vy (m/s)','|V| (m/s)','ax (m/s^2)','ay (m/s^2)'];
    const lines = [header.join(',')];
    for (const r of rows) {
      lines.push(r.map(v => (typeof v === 'number') ? v.toPrecision(12) : v).join(','));
    }
    return lines.join('\\n');
  }

  // DOM elemanları
  const v0El = document.getElementById('v0');
  const thetaEl = document.getElementById('theta');
  const h0El = document.getElementById('h0');
  const useManualEl = document.getElementById('useManual');
  const axManualEl = document.getElementById('ax_manual');
  const ayManualEl = document.getElementById('ay_manual');
  const dtEl = document.getElementById('dt');
  const maxTimeEl = document.getElementById('max_time');
  const minRowsEl = document.getElementById('min_rows');

  const runBtn = document.getElementById('runBtn');
  const resetBtn = document.getElementById('resetBtn');
  const downloadCsvBtn = document.getElementById('downloadCsv');
  const copyCsvBtn = document.getElementById('copyCsv');

  const summaryBox = document.getElementById('summaryBox');
  const first10Box = document.getElementById('first10');
  const last10Box = document.getElementById('last10');

  let lastCSV = '';
  let lastRows = [];

  // Varsayılanları sıfırlama
  function resetDefaults() {
    v0El.value = 25;
    thetaEl.value = 45;
    h0El.value = 0;
    useManualEl.value = 'false';
    axManualEl.value = 0.0;
    ayManualEl.value = -20.0;
    dtEl.value = 0.01;
    maxTimeEl.value = 30.0;
    minRowsEl.value = 1000;
  }
  resetBtn.addEventListener('click', resetDefaults);

  // Simülasyonu çalıştır
  runBtn.addEventListener('click', () => {
    runBtn.disabled = true;
    runBtn.textContent = 'Çalışıyor...';
    setTimeout(() => {
      try {
        runSimulation();
      } catch (e) {
        alert('Hata: ' + e.message);
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'Simülasyonu Çalıştır';
      }
    }, 10);
  });

  // CSV indirme
  downloadCsvBtn.addEventListener('click', () => {
    if (!lastCSV) { alert('Önce simülasyonu çalıştırın.'); return; }
    const blob = new Blob([lastCSV], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'projectile_data.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // CSV kopyala
  copyCsvBtn.addEventListener('click', async () => {
    if (!lastCSV) { alert('Önce simülasyonu çalıştırın.'); return; }
    try {
      await navigator.clipboard.writeText(lastCSV);
      alert('CSV panoya kopyalandı.');
    } catch (e) {
      alert('Panoya kopyalama başarısız: ' + e.message);
    }
  });

  // Ana simülasyon fonksiyonu
  function runSimulation() {
    // Parametreleri oku
    let v0 = parseFloat(v0El.value);
    let theta_deg = parseFloat(thetaEl.value);
    let h0 = parseFloat(h0El.value);
    const useManual = (useManualEl.value === 'true');
    let ax_manual = parseFloat(axManualEl.value);
    let ay_manual = parseFloat(ayManualEl.value);
    let dt = parseFloat(dtEl.value);
    const max_time = parseFloat(maxTimeEl.value);
    const min_rows = Math.max(1, parseInt(minRowsEl.value));

    // Varsayılan dünya ivmesi
    const default_ax = 0.0;
    const default_ay = -20.0;

    const ax = useManual ? ax_manual : default_ax;
    const ay = useManual ? ay_manual : default_ay;

    // Başlangıç durumları
    const theta = deg2rad(theta_deg);
    const vx0 = v0 * Math.cos(theta);
    const vy0 = v0 * Math.sin(theta);

    // Başlangıç state: [x, y, vx, vy]
    let state = [0.0, h0, vx0, vy0];

    // Veri saklama
    const rows = [];
    let t = 0.0;
    let step = 0;

    // Simülasyon döngüsü (RK4)
    // Simülasyon y <= 0 (zemine çarpma) ile sonlanır; eğer erken bitiyorsa dt küçültülerek tekrar çalıştırılır
    function singleRun(local_dt) {
      rows.length = 0;
      t = 0.0;
      step = 0;
      state = [0.0, h0, vx0, vy0];
      while (t <= max_time + 1e-12 && rows.length < 200000) {
        const speed = Math.hypot(state[2], state[3]);
        rows.push([t, state[0], state[1], state[2], state[3], speed, ax, ay]);
        // Eğer y <= 0 ve t>0 ise çarpma gerçekleşti; son noktayı daha doğru bulmak için lineer interpolasyon yap
        if (state[1] <= 0 && t > 0) {
          break;
        }
        // RK4 adımı
        state = rk4_step(state, [ax, ay], local_dt);
        t += local_dt;
        step++;
      }
      return rows;
    }

    // İlk çalıştırma
    let produced = singleRun(dt);

    // Eğer satır sayısı < min_rows ve simülasyon erken bitmişse dt'yi küçültüp yeniden üret
    if (produced.length < min_rows) {
      // dt'yi otomatik küçültme stratejisi: dt_new = dt * (produced/min_rows)
      // ama dt küçültme faktörü çok büyükse kademeli azalt
      let attempts = 0;
      while (produced.length < min_rows && attempts < 12) {
        attempts++;
        // hedeflenen dt
        const ratio = produced.length / min_rows;
        // güvenli küçültme: dt_new = dt * max(0.2, ratio)
        const factor = Math.max(0.05, ratio);
        dt = Math.max(1e-5, dt * factor);
        produced = singleRun(dt);
      }
    }

    // Eğer hala yeterli değilse max_time'ı artır ve tekrar
    if (produced.length < min_rows) {
      let attempts = 0;
      let newMax = max_time;
      while (produced.length < min_rows && attempts < 8) {
        attempts++;
        newMax *= 1.5;
        // geçici max_time ile yeniden çalıştır
        const oldMax = parseFloat(maxTimeEl.value);
        const tmpMax = newMax;
        // run with extended max_time by temporarily overriding
        const savedMax = parseFloat(maxTimeEl.value);
        // run singleRun with closure using tmpMax by temporarily setting max_time variable
        // (we'll implement a quick local runner)
        function singleRunWithMax(local_dt, local_max) {
          const tmpRows = [];
          let tmpState = [0.0, h0, vx0, vy0];
          let tmpT = 0.0;
          while (tmpT <= local_max + 1e-12 && tmpRows.length < 500000) {
            const speed = Math.hypot(tmpState[2], tmpState[3]);
            tmpRows.push([tmpT, tmpState[0], tmpState[1], tmpState[2], tmpState[3], speed, ax, ay]);
            if (tmpState[1] <= 0 && tmpT > 0) break;
            tmpState = rk4_step(tmpState, [ax, ay], local_dt);
            tmpT += local_dt;
          }
          return tmpRows;
        }
        produced = singleRunWithMax(dt, tmpMax);
      }
    }

    // Eğer hala yeterli değilse uyarı ver ama devam et
    if (produced.length < min_rows) {
      alert('Uyarı: Hedef satır sayısına ulaşılamadı. Üretilen satır sayısı: ' + produced.length);
    }

    // Sonuçları kaydet
    lastRows = produced.slice(); // kopya
    lastCSV = arrayToCSV(lastRows);

    // Özet hesaplamaları
    const flightTime = produced[produced.length-1][0];
    // maksimum yükseklik
    let maxH = -Infinity;
    let timeToPeak = 0;
    for (const r of produced) {
      if (r[2] > maxH) { maxH = r[2]; timeToPeak = r[0]; }
    }
    // menzil (x at impact)
    const range = produced[produced.length-1][1];
    // çarpma hızı ve açısı
    const last = produced[produced.length-1];
    const impactSpeed = last[5];
    const impactAngleRad = Math.atan2(last[4], last[3]); // vy, vx
    const impactAngleDeg = impactAngleRad * 180.0 / Math.PI;

    // Konsol ve özet kutusu güncelle
    summaryBox.innerHTML = '';
    const sHtml = document.createElement('div');
    sHtml.innerHTML = '<p><strong>Uçuş süresi:</strong> ' + formatNum(flightTime,4) + ' s</p>'
      + '<p><strong>Maksimum yükseklik:</strong> ' + formatNum(maxH,4) + ' m</p>'
      + '<p><strong>Menzil (x):</strong> ' + formatNum(range,4) + ' m</p>'
      + '<p><strong>Çarpma hızı:</strong> ' + formatNum(impactSpeed,4) + ' m/s</p>'
      + '<p><strong>Çarpma açısı:</strong> ' + formatNum(impactAngleDeg,3) + ' °</p>'
      + '<p><strong>Zaman tepe:</strong> ' + formatNum(timeToPeak,4) + ' s</p>'
      + '<p><strong>Toplam satır:</strong> ' + produced.length + '</p>';
    summaryBox.appendChild(sHtml);

    // İlk 10 ve son 10 satırı tablo olarak göster
    function makeTableFromRows(rows) {
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>t (s)</th><th>x (m)</th><th>y (m)</th><th>vx (m/s)</th><th>vy (m/s)</th><th>|V| (m/s)</th><th>ax</th><th>ay</th></tr>';
      tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (let i=0;i<r.length;i++) {
          const td = document.createElement('td');
          td.textContent = formatNum(r[i],5);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tbl.appendChild(tbody);
      return tbl;
    }

    const first10 = produced.slice(0, Math.min(10, produced.length));
    const last10 = produced.slice(Math.max(0, produced.length-10));
    first10Box.innerHTML = '';
    last10Box.innerHTML = '';
    first10Box.appendChild(makeTableFromRows(first10));
    last10Box.appendChild(makeTableFromRows(last10));

    // Grafik verilerini hazırla
    const tArr = produced.map(r => r[0]);
    const xArr = produced.map(r => r[1]);
    const yArr = produced.map(r => r[2]);
    const vxArr = produced.map(r => r[3]);
    const vyArr = produced.map(r => r[4]);
    const speedArr = produced.map(r => r[5]);
    const axArr = produced.map(r => r[6]);
    const ayArr = produced.map(r => r[7]);

    // Pozisyon grafiği: x(t) ve y(t) ayrı altgrafiklerde
    const posLayout = {
      title: 'Konum - Zaman',
      grid: {rows:2, columns:1, pattern:'independent'},
      height: 320,
      margin: {t:40, l:60, r:20, b:40},
      xaxis: {title:'t (s)', showgrid:true, zeroline:false},
      xaxis2: {title:'t (s)', showgrid:true, zeroline:false},
      yaxis: {title:'x (m)', showgrid:true},
      yaxis2: {title:'y (m)', showgrid:true}
    };
    const posData = [
      { x: tArr, y: xArr, name:'x(t) (m)', xaxis:'x1', yaxis:'y1', mode:'lines+markers', marker:{size:4}, line:{width:2} },
      { x: tArr, y: yArr, name:'y(t) (m)', xaxis:'x2', yaxis:'y2', mode:'lines+markers', marker:{size:4}, line:{width:2} }
    ];
    Plotly.newPlot('posPlot', posData, posLayout, {responsive:true});

    // Hız grafiği: |V|(t), vx, vy
    const speedLayout = {
      title: 'Hız - Zaman',
      height: 300,
      margin: {t:40, l:60, r:20, b:40},
      xaxis: {title:'t (s)', showgrid:true},
      yaxis: {title:'Hız (m/s)', showgrid:true}
    };
    const speedData = [
      { x: tArr, y: speedArr, name:'|V|(t) (m/s)', mode:'lines+markers', marker:{size:4}, line:{width:2, color:'#0b69ff'} },
      { x: tArr, y: vxArr, name:'vx (m/s)', mode:'lines+markers', marker:{size:3}, line:{width:1.5, dash:'dash', color:'#ff7f0e'} },
      { x: tArr, y: vyArr, name:'vy (m/s)', mode:'lines+markers', marker:{size:3}, line:{width:1.5, dash:'dot', color:'#2ca02c'} }
    ];
    Plotly.newPlot('speedPlot', speedData, speedLayout, {responsive:true});

    // İvme grafiği
    const accLayout = {
      title: 'İvme - Zaman',
      height: 240,
      margin: {t:40, l:60, r:20, b:40},
      xaxis: {title:'t (s)', showgrid:true},
      yaxis: {title:'İvme (m/s²)', showgrid:true}
    };
    const accData = [
      { x: tArr, y: axArr, name:'ax (m/s²)', mode:'lines+markers', marker:{size:4}, line:{width:2, color:'#8a2be2'} },
      { x: tArr, y: ayArr, name:'ay (m/s²)', mode:'lines+markers', marker:{size:4}, line:{width:2, color:'#d62728'} }
    ];
    Plotly.newPlot('accPlot', accData, accLayout, {responsive:true});

    // Hover ve eksen sayı biçimlendirmesi: tüm grafiklerde eksenlerde sayılar görünür (Plotly varsayılan)
    // Son olarak kullanıcıya bilgi ver
    console.log('Simülasyon tamamlandı. Satır sayısı:', produced.length);
  }

  // Sayfa yüklendiğinde varsayılan simülasyonu çalıştır
  window.addEventListener('load', () => {
    // Otomatik çalıştırma istenirse uncomment:
    // document.getElementById('runBtn').click();
  });
  </script>
</body>
</html>
